name: "Build project with tests"

on:
  pull_request:
    branches-ignore: [ ]
  workflow_dispatch:

jobs:
  build:
    name: Build project with tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gettext for envsubst
        run: |
          sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Create settings.xml with environment variables
        run: |
          # Создаем шаблон settings.xml из секрета
          echo "${{ secrets.MAVEN_SETTINGS_XML }}" > ./settings-template.xml

          # Экспортируем переменные для envsubst
          export GITHUB_USER="${{ secrets.GITHUB_USER }}"
          export PACKAGES_TOKEN="${{ secrets.PACKAGES_TOKEN }}"

          # Применяем подстановку переменных
          envsubst < ./settings-template.xml > ./settings.xml

          # Проверяем результат
          if [ -s ./settings.xml ]; then
            echo "settings.xml successfully created with environment variables"
            echo "=== settings.xml content ==="
            cat ./settings.xml
            echo "=== end of settings.xml ==="
          else
            echo "ERROR: settings.xml is empty or not created"
            exit 1
          fi

          # Очищаем шаблон
          rm -f ./settings-template.xml

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '24'
          distribution: 'temurin'

      - name: Build project with Maven
        run: |
          chmod +x ./mvnw && \
          ./mvnw clean install -s ./settings.xml

      - name: Clean up temporary files (security)
        run: |
          rm -f settings.xml